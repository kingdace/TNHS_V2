;/*FB_PKG_DELIM*/

__d("LSDeleteThreadCentricMessages",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.db.table(12).fetch([[[e[0],{lte:e[1]}]]]),function(e){return e.delete()})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxDeleteThreadCentricMessagesStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSHandleRepliesOnRemove",["LSDeleteMessage"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(r){return t.sequence([function(r){return t.forEach(t.filter(t.db.table(12).fetch([[[e[1]]],"replySourceIdMessageID"]),function(n){return t.i64.eq(n.threadKey,e[0])&&n.replySourceId===e[1]&&t.i64.eq(n.replyType,t.i64.cast([0,1]))}),function(e){var r=e.item;return t.storedProcedure(n("LSDeleteMessage"),r.threadKey,r.messageId)})},function(n){return t.forEach(t.filter(t.db.table(12).fetch([[[e[1]]],"replySourceIdMessageID"]),function(n){return t.i64.eq(n.threadKey,e[0])&&n.replySourceId===e[1]}),function(e){var n=e.item;return t.forEach(t.filter(t.db.table(12).fetch([[[n.threadKey,n.timestampMs,n.messageId]]]),function(e){return t.i64.eq(e.threadKey,n.threadKey)&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(e.timestampMs,n.timestampMs)&&e.messageId===n.messageId}),function(e){var t=e.update,n=e.item;return t({replySourceId:void 0,replySourceTimestampMs:void 0,replySourceType:void 0,replySourceTypeV2:void 0,replySnippet:void 0,replyStatus:void 0,replyToUserId:void 0,replyMessageText:void 0,replyMediaExpirationTimestampMs:void 0,replyMediaUrl:void 0,replyMediaUrlFallback:void 0,replyMediaPreviewWidth:void 0,replyMediaPreviewHeight:void 0,replyMediaUrlMimeType:void 0,replyAttachmentType:void 0,replyAttachmentId:void 0,replyAttachmentExtra:void 0})})})}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxHandleRepliesOnRemoveStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSLocalMarkThreadRead",["LSMarkThreadRead"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return t.db.table(9).fetch([[[e[0]]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?(r[2]=t.createArray(),r[3]=(r[2].push("localMarkThreadRead unable to find thread key in DB:"),r[2]),r[4]=(r[2].push(e[0]),r[2]),r[5]=t.toJSON(r[2]),(function(e){t.logger(e).mustfix(e)})(r[5]),r[0]=void 0):(a=l.item,t.sequence([function(e){return r[4]=a.lastActivityTimestampMs,r[5]=a.lastReadWatermarkTimestampMs,r[6]=a.threadKey,t.islc(t.db.table(12).fetchDesc([[[r[6]]]]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,o){var a=e.done,i=e.value;return a?(r[7]=t.createArray(),r[8]=(r[7].push("localMarkThreadRead unable to find message with thread key in DB:"),r[7]),r[9]=(r[7].push(r[6]),r[7]),r[10]=t.toJSON(r[7]),(function(e){t.logger(e).mustfix(e)})(r[10]),r[2]=void 0):(o=i.item,t.sequence([function(e){return r[16]=o.timestampMs,r[7]=t.createArray(),r[8]=(r[7].push("localMarkThreadRead"),r[7]),r[9]=(r[7].push("lastMessageTimestampMs"),r[7]),r[10]=(r[7].push(r[16]),r[7]),r[11]=(r[7].push("currentLastActivityTimestampMs"),r[7]),r[12]=(r[7].push(r[4]),r[7]),r[13]=(r[7].push("currentLastReadWatermarkTimestampMs"),r[7]),r[14]=(r[7].push(r[5]),r[7]),r[15]=t.toJSON(r[7]),(function(e){t.logger(e).info(e)})(r[15]),r[18]=t.i64.gt(r[16],r[4])?r[16]:r[4],t.i64.gt(r[18],r[5])?t.sequence([function(e){return t.storedProcedure(n("LSMarkThreadRead"),r[18],r[6])},function(e){return r[17]=r[18]}]):t.resolve(r[17]=void 0)},function(e){return r[2]=r[17]}]))})},function(e){return r[0]=r[2]}]))})},function(e){return o[0]=r[0]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxLocalMarkThreadReadStoredProcedure",e.__tables__=["threads","messages"],a.exports=e}),null);
__d("LSRefreshLastActivityTimestamp",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return t.db.table(12).fetchDesc([[[e[0]]]]).next().then(function(e,r){var o=e.done,a=e.value;return o?n[0]=t.i64.cast([0,0]):(r=a.item,n[0]=r.timestampMs)})},function(r){return t.db.table(9).fetch([[[e[0]]]]).next().then(function(e,r){var o=e.done,a=e.value;return o?n[2]=t.i64.cast([0,0]):(r=a.item,n[2]=r.lastActivityTimestampMs)})},function(r){return t.i64.neq(n[0],t.i64.cast([0,0]))&&t.i64.neq(n[0],n[2])?t.forEach(t.db.table(9).fetch([[[e[0]]]]),function(e){var t=e.update,r=e.item;return t({lastActivityTimestampMs:n[0]})}):t.resolve()}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxRefreshLastActivityTimestampStoredProcedure",e.__tables__=["messages","threads"],a.exports=e}),null);
__d("LSUpdateSelectiveSyncState",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.filter(t.db.table(9).fetch([[[e[0]]]]),function(n){return t.i64.eq(n.threadKey,e[0])&&([t.i64.cast([0,23]),t.i64.cast([0,21]),t.i64.cast([0,18]),t.i64.cast([0,26]),t.i64.cast([0,27])].some(function(e){return t.i64.eq(n.threadType,e)})||t.i64.eq(n.threadType,t.i64.cast([0,152])))}).next().then(function(n,r){var o=n.done,a=n.value;return o?t.db.table(294).add({threadKey:e[0],threadQueueSequenceId:t.i64.cast([0,0]),lastSelectiveSyncTimestampMs:e[1]}):(r=a.item,t.forEach(t.db.table(294).fetch([[[e[0]]]]),function(t){var n=t.update,r=t.item;return n({lastSelectiveSyncTimestampMs:e[1]})}))})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxUpdateSelectiveSyncStateStoredProcedure",e.__tables__=["threads","community_thread_sync_info"],a.exports=e}),null);
__d("LSUpsertThreadMemberCount",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.db.table(9).fetch([[[e[0]]]]),function(t){var n=t.update,r=t.item;return n({memberCount:e[1]})})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxUpsertThreadMemberCountStoredProcedure",e.__tables__=["threads"],a.exports=e}),null);