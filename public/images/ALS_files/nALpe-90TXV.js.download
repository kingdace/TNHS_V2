;/*FB_PKG_DELIM*/

__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["I64","MAWEBUnstoredDbMsgUtils","MAWJobDefinitions","MAWUserJidWrapper","MpsOverBridge","MpsTypes","WAJids","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a,i,l){i===void 0&&(i=function(){});var s=o("WAJids").threadIdForChatJid(t),u=n==null?Date.now()+6e4:Number(n);return i(),o("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!1,shouldFetchTags:!1,shouldIgnoreLocalOnly:!0,strategy:"remote-only"},debug:{purpose:"MAWAsyncEBIssueFetchAndIndexFTSQuery_"+l},direction:"desc",from:[o("MpsTypes").toTimestamp(u),null],numMessages:(e||(e=o("I64"))).to_int32(a),threadId:o("MpsTypes").toThreadId(t)}).then(function(n){var a;if(n.success===!1)throw n.payload||r("err")(n.error);var i=n.value.messages.map(o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage),l=n.value.cursorInfo.hasNext?(a=n.value.cursorInfo.endCursor)==null?void 0:a[0]:0;return{echoMessages:[],hasMoreAfter:n.value.cursorInfo.hasPrevious,hasMoreBefore:n.value.cursorInfo.hasNext,isPointQuery:!1,messages:o("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(i,void 0,t,o("MAWUserJidWrapper").getMyUserJid()),nextMessageTimestampMsBefore:l==null?void 0:(e||(e=o("I64"))).of_float(l),protobufMessages:i,referenceTimestamp:u.toString(),requestId:void 0,restoreType:"protobuf",threadId:s}})}l.issueQueryAsPromise=s}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(t,n,r,o,a,i){"use strict";var e=null,l=[],s=[],u=[],c=null,d=2e3,m=10;function p(t,n,r,o,a,i,p,_,f,g){g==null||g.addPoint("buffer_and_restore_protobuf_start");var h=function(){l=l.concat(n),s=s.concat(r!=null?r:[]),g!=null&&u.push(g),l.length>=m?(u.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"max_buffer_size"}})}),f(t,l,s,o,a,i,p,_,u),l=[],s=[],u=[]):c=window.setTimeout(function(){var e=[].concat(l),n=[].concat(s),r=[].concat(u);r.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"timeout"}})}),f(t,e,n,o,a,i,p,_,r),l=[],s=[],u=[]},d)},y=function(){window.clearTimeout(c);var t=l.map(function(e){return e}),n=s.map(function(e){return e}),r=[].concat(u),d=e;d!=null&&(r.forEach(function(e){return e.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"immediately"}})}),f(d,t,n,o,a,i,p,_,r)),l=[],s=[],u=[]};if(t!==e){y(),e=t,h();return}l.length===0?h():(l=l.concat(n),s=s.concat(r!=null?r:[]),g!=null&&u.push(g),l.length>=m&&y())}i.bufferAndRestoreProtobuf=p}),66);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={mediaCount:0,messageCount:0,threadId:(e||(e=o("I64"))).zero};async function c(t,n,r){var a=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton,l=await a.runInTransaction(function(n){return o("MAWChatJid").toThreadKeyMaybeForChatJidInteger(n,(e||(e=o("I64"))).of_string(t))},"readwrite",void 0,void 0,i.id+":35");u.threadId===l?(u.messageCount+=n,u.mediaCount+=r):(u.messageCount=n,u.mediaCount=r,u.threadId=l!=null?l:(e||(e=o("I64"))).zero)}function d(){return u}l.updateRestoreStatus=c,l.getRestoreStatus=d}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","EchoMessage","EchoMessageMediaFieldUtils","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryEBTaggingUtils","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;async function g(t,n){var a=t.echoMessages,l=t.hasMoreAfter,f=t.hasMoreBefore,g=t.isPointQuery,y=t.protobufMessages,C=t.referenceTimestamp,b=t.requestId,v=t.restoreType,S=t.threadId;if(S==null){n==null||n.endFail("threadId is null"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"])));return}n==null||n.addAnnotations({string:{restore_type:v}}),n==null||n.addPoint("handle_media_restore_sync_start");var R=!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled();if(v==="echo"){var L;if(a==null){n==null||n.endFail("echoMessages is null"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: echoMessages is null"])));return}n==null||n.addPoint("messages_decoding_and_filtering_start");var E=a.filter(function(e){var t,n=o("EchoMessage").decodeEchoMessage(e);return R?(n==null?void 0:n.contentType)===o("EchoMessage").EchoMessageContentType.MEDIA:(n==null||(t=n.mediaData)==null?void 0:t.attachmentType)===o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT});n==null||n.addPoint("messages_decoding_and_filtering_end"),E.length>0&&o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0),n==null||n.addAnnotations({int:{media_count:E.length,message_count:a.length}}),n==null||n.addPoint("update_media_restore_status_start"),await o("MWMediaRestoreStatus").updateRestoreStatus(S,a.length,E.length),n==null||n.addPoint("update_media_restore_status_end"),n==null||n.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(L=a==null?void 0:a.length)!=null?L:0,protobuf_msg_count:E.length}}),r("promiseDone")(o("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",o("MAWJobDefinitions").toThreadJidPrimaryId(S),E.map(o("MAWJobDefinitions").toEncodedEchoMessage),f,void 0,l,void 0,g,b,C,r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW).catch(function(e){n==null||n.endFail(e),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Echo error: ",""])),e)}),function(){n==null||n.addPoint("restore_messages_in_worker_end"),n==null||n.addPoint("restore_messages_update_ranges_start"),r("promiseDone")((p||(p=o("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(e){n==null||n.addPoint("update_range_get_thread_key_start");var t=await e.runInTransaction(function(e){return o("MAWChatJid").toThreadKeyMaybeForChatJidInteger(e,(_||(_=o("I64"))).of_string(S))},"readonly",void 0,void 0,i.id+":151");if(n==null||n.addPoint("update_range_get_thread_key_end"),t==null){n==null||n.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return Promise.all([h(e,t,r("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),h(e,t,r("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),n==null||n.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),n==null||n.addPoint("handle_media_restore_sync_end"),n==null||n.endSuccess()}))})}else if(v==="protobuf"){if(y==null){n==null||n.endFail("protobufMessages is null"),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: protobufMessages is null"])));return}n==null||n.addPoint("get_user_jid_start");var k=o("MAWJids").toUserJid(r("CurrentUser").getAccountID());n==null||n.addPoint("get_user_jid_end"),n==null||n.addPoint("messages_decoding_and_filtering_start");var I=y.filter(function(e){var t=o("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(e,k,void 0,new Set,new Set,new Map,new Map,new Map,!0);return R&&[o("WAMsgType").MSG_TYPE.IMAGE,o("WAMsgType").MSG_TYPE.VIDEO].includes(t.msgType)||t.msgType===o("WAMsgType").MSG_TYPE.DOCUMENT_FILE});n==null||n.addPoint("messages_decoding_and_filtering_end"),I.length>0&&o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0),n==null||n.addAnnotations({int:{media_count:I.length,message_count:y.length}}),n==null||n.addPoint("update_media_restore_status_start"),await o("MWMediaRestoreStatus").updateRestoreStatus(S,y.length,I.length),n==null||n.addPoint("update_media_restore_status_end");var T=function(t,n,a,l,s,u,c,m,f){var e;if(((e=a==null?void 0:a.length)!=null?e:0)===0&&n.length===0){f.forEach(function(e){e.addPoint("restore_messages_in_worker_skipped"),e.endSuccess()});return}f.forEach(function(e){var t;return e.addPoint("restore_messages_in_worker_start",{int:{echo_msg_count:(t=a==null?void 0:a.length)!=null?t:0,protobuf_msg_count:n.length}})}),r("promiseDone")(o("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",o("MAWJobDefinitions").toThreadJidPrimaryId(t),n,l,void 0,s,void 0,u,c,m,void 0,a,(_||(_=o("I64"))).of_int32(r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,void 0).catch(function(e){f.forEach(function(t){return t.endFail(e)}),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""])),e)}),function(){f.forEach(function(e){return e.addPoint("restore_messages_in_worker_end")}),f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_start")}),r("promiseDone")((p||(p=o("LSDatabaseSingleton"))).LSDatabaseSingleton.then(async function(e){f.forEach(function(e){return e.addPoint("update_range_get_thread_key_start")});var t=await e.runInTransaction(function(e){return o("MAWChatJid").toThreadKeyMaybeForChatJidInteger(e,(_||(_=o("I64"))).of_string(S))},"readonly",void 0,void 0,i.id+":314");if(f.forEach(function(e){return e.addPoint("update_range_get_thread_key_end")}),t==null){f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}})});return}return Promise.all([h(e,t,r("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),h(e,t,r("LSThreadMediaGalleryGroup").FILES_ONLY)])}).then(function(){o("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),f.forEach(function(e){return e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}})}),f.forEach(function(e){return e.addPoint("handle_media_restore_sync_end")}),f.forEach(function(e){return e.endSuccess()})}))})};o("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(S,I,a,f,l,g,b,C,T,n)}else n==null||n.endFail("RestoreType is none"),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore RestoreType is none"])))}function h(e,t,n){return o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryGroupSupportedForTaggedRestore(n)?Promise.resolve():e.runInTransaction(async function(r){var a=await o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.attachments_ranges_v2__generated).getKeyRange(t).filter(function(e){return(_||(_=o("I64"))).equal(e.mediaGroup,(f||(f=o("LSIntEnum"))).ofNumber(n))}));if(!(a==null||(a==null?void 0:a.hasMoreBefore)===!0)){var i=babelHelpers.extends({},a,{hasMoreBefore:!0});return r.attachments_ranges_v2__generated.upsert([a.threadKey,a.mediaGroup,a.minTimestampMs],i)}},"readwrite","ui",void 0,i.id+":395")}l.handleMediaRestoreSync=g}),98);
__d("MWEncryptedBackUpEBNotEnabledError",[],(function(t,n,r,o,a,i){"use strict";var e="EB not enabled";i.EB_NOT_ENABLED=e}),66);
__d("MWMediaRestoreQplUtils",["QPLFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=18e4;function s(){var t=r("qpl")._(25304794,"2287");return o("QPLFlow").startQPLFlow(t,{timeoutInMs:e})}function u(){var t=r("qpl")._(25306381,"2492");return o("QPLFlow").startQPLFlow(t,{timeoutInMs:e})}l.startMediaRestoreBatchQPLFlow=s,l.startMediaRestoreLoadAllQPLFlow=u}),98);
__d("isEbEnabledWithIGDEligibilityCheck",["EBIsEbEnabled","Promise","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return r("gkx")("23914")?o("EBIsEbEnabled").isEbEnabledLS(t.tables):(e||(e=n("Promise"))).resolve(!1)}l.isEbEnabledWithIGDEligibilityCheck=s}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeFireAndForget","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWDbMsg","MAWFTSIsMessageValidForSearch","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","QPLFlow","WAPromiseDelays","cr:19810","err","getErrorSafe","isEbEnabledWithIGDEligibilityCheck","justknobx","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(r("EventEmitter")),c=(e||(e=o("I64"))).of_int32(r("justknobx")._("2477")),d=r("justknobx")._("2606"),m=r("uuidv4")();function p(e){return new Promise(function(t,n){return globalThis.setTimeout(function(){return n(r("err")("timeout"))},e)})}function _(){window.setInterval(function(){o("MAWBridgeFireAndForget").fireAndForget("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:m},!0)},1e3)}async function f(e){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:e,tabId:m})}async function g(){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:m})}function h(e){var t=200,n=12e4;return Math.min(t*Math.pow(3,e),n)}var y=(function(){function t(e){e===void 0&&(e="search"),this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set,this.$8=new Set,this.$9=new Set,this.$10=e,r("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance: "+e)}var a=t.prototype;return a.setIsStarted=function(t){this.$1=t,this.$10==="media"&&u.emit("isSyncStarted",t)},a.setIsEBMaybeAvailable=function(t){this.$4=t,this.$10==="media"&&u.emit("isEBMaybeAvailable",t)},a.setActiveThreadId=function(t,r){r===void 0&&(r=!0),n("cr:19810")!=null&&r&&t!=null&&n("cr:19810").getInstance().insertIntoHead(t),this.$5=t,this.$10==="media"&&u.emit("activeThreadJid",t)},a.setShouldPauseRestore=function(t){this.$3=t},a.removeFromQueue=function(t){n("cr:19810")!=null&&t!=null&&n("cr:19810").getInstance().removeThread(t)},a.getActiveThreadId=function(){return this.$5},a.getNextThreadIdToFetch=function(){if(n("cr:19810")!=null){var e;return(e=n("cr:19810").getInstance().getThreadsHead())!=null?e:this.getActiveThreadId()}return this.getActiveThreadId()},a.getDoneThreads=function(){return this.$7},a.getDoneThreadsAfterReset=function(){return this.$9},a.getResetThreads=function(){return this.$8},a.isStarted=function(){return this.$1},a.isEBMaybeAvailable=function(){return this.$4},a.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)},a.resetRestoreStatus=function(){var e=this,t=this.getActiveThreadId();return t!=null&&!this.$8.has(t)?o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSClearThreadRestoreStatus",{threadId:t},{isLoggingDisabled:!0}).then(function(){e.$8.add(t)}):Promise.resolve()},a.$11=function(t,n){var e=this;Object.keys(this.$6).forEach(function(r){e.$6[r](t,n)})},a.$12=function(t,r,a){return t!==r&&n("cr:19810")!=null?a==null||o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(a,10)):a!=="0"},a.$13=async function(){this.setIsStarted(!0),this.setShouldPauseRestore(!1),await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0}),window.addEventListener("focus",async function(){await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:m},{isLoggingDisabled:!0})}),_()},a.shouldLoop=async function(t){if(this.$1||this.$4===!1)return!1;await this.$13();var e=await o("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(t);return e?!0:(this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),!1)},a.loadMessages=async function(n,a,i,l,s,u,_){var t=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:m,threadJid:n});if(!t)return await o("WAPromiseDelays").delayMs(200),"CONTINUE";var h=o("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(n,a,c,i,u);if(h==null)return this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),"STOP";var y=s();y.addAnnotations({int:{retryCount:l},string:{restoreUntilMs:a!=null?a:""}});try{var C=function(){return Promise.race([h,p(d)])},b=await o("QPLFlow").QplSubspan.wrapInSubspan(y,"fetch_request",C),v=b.nextMessageTimestampMsBefore!=null?(e||(e=o("I64"))).to_int32(b.nextMessageTimestampMsBefore):void 0,S=Number(a)===v;return y.addAnnotations({bool:{paginationStuck:S},int:{numMessages:b.messages.length}}),S&&v!=null&&r("justknobx")._("263")&&(b=babelHelpers.extends({},b,{nextMessageTimestampMsBefore:(e||(e=o("I64"))).of_int32(v-1)})),await o("QPLFlow").QplSubspan.wrapInSubspan(y,"process_data",function(){return _(b,y)}),y.endSuccess(),await f(),"CONTINUE"}catch(e){var R,L=r("getErrorSafe")(e);return L&&L.message===o("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED?(y.addPoint("eb_not_enabled"),y.endCancel(),this.setIsEBMaybeAvailable(!1),this.setIsStarted(!1),await g(),"STOP"):(L.message==="invalid-client-state"||(r("FBLogger")("fts_worker").catching(L).mustfix("Fail to fetch a new batch of messages"),y.endFail((R=L.message)!=null?R:"unknown"),await f(L)),"FAIL")}},a.startSyncingLoop=async function(){var t=this;this.setShouldPauseRestore(!1);var a=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton;if(await this.shouldLoop(a)){await o("MAWFTSRestoreSyncLogger").initLoggingSessionId();for(var i=0,l=null,u=async function(){var a,s=t.getNextThreadIdToFetch(),u=t.getActiveThreadId();if(l!==s&&(l=s,i=0),s==null||n("cr:19810")==null&&t.$7.has(s))return await o("WAPromiseDelays").delayMs(200),0;if(t.$3)return await o("WAPromiseDelays").delayMs(200),0;var c=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:s},{isLoggingDisabled:!0}),d=(a=c==null?void 0:c.restoredUntilSortOrderMs)!=null?a:null,m=c==null||c.restoredUntilSortOrderMs===c.maxRestoredUntilSortOrderMs||c.restoredUntilSortOrderMs==null,p=t.$12(s,u,d);if(!p)return d==="0"&&(t.$7.add(s),t.$8.has(s)&&t.$9.add(s)),t.removeFromQueue(s),await o("WAPromiseDelays").delayMs(200),0;var _=await t.loadMessages(s,d,function(){o("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(s,d==null||o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(d,10)),m)},i,function(){return o("QPLFlow").startQPLFlow(r("qpl")._(25300854,"2397"))},"fts",async function(n){var r=n.messages,a=n.nextMessageTimestampMsBefore,i=a!=null?(e||(e=o("I64"))).to_string(a):"0",l=o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(i,10));o("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(s,r.length,l),t.$11(s,r);var u=r.map(function(e){var t=o("MAWFTSIsMessageValidForSearch").verifyMessageValidity(e);return t==null?null:o("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers.extends({author:e.author,canonicalTs:o("MAWDbMsg").getCanonicalTsFromMsg(e),externalId:e.externalId,threadJid:s},t),!1)}).filter(Boolean);await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:i,threadId:s,unvaultedBridgeSearchMessages:u})});e:{if(_==="CONTINUE"){i=0;break e}if(_==="FAIL"){o("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(s),await o("WAPromiseDelays").delayMs(h(i)),i++;break e}if(_==="STOP")return{v:void 0};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+_)}},c;this.$2;)if(c=await u(),c!==0&&c)return c.v}},a.startMediaSyncingLoop=async function(){var t=this,n=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton;if(await this.shouldLoop(n)){for(var r=0,a=async function(){var n,a=t.getActiveThreadId();if(a==null||t.$7.has(a))return await o("WAPromiseDelays").delayMs(200),0;if(t.$3)return await o("WAPromiseDelays").delayMs(200),0;var i=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:a},{isLoggingDisabled:!0}),l=(n=i==null?void 0:i.restoredUntilSortOrderMs)!=null?n:null;u.emit("restoredUntilMs",l!=null?parseInt(l,10):-1);var s=t.$12(a,a,l);if(!s)return l==="0"&&t.$7.add(a),await o("WAPromiseDelays").delayMs(200),0;var c=await t.loadMessages(a,l,void 0,r,o("MWMediaRestoreQplUtils").startMediaRestoreBatchQPLFlow,"media",async function(t,n){var r=t.nextMessageTimestampMsBefore!=null?(e||(e=o("I64"))).to_string(t.nextMessageTimestampMsBefore):"0";await o("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(t,n),await o("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:r,threadId:a},{isLoggingDisabled:!0})});e:{if(c==="CONTINUE"){r=0;break e}if(c==="FAIL"){await o("WAPromiseDelays").delayMs(h(r)),r++;break e}if(c==="STOP")return{v:void 0};throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+c)}},i;this.$2;)if(i=await a(),i!==0&&i)return i.v}},t.getInstance=function(){var e=t.instance;if(e!=null)return e;var n=new t;return t.instance=n,n},t.getMediaInstance=function(){var e=t.mediaInstance;if(e!=null)return e;var n=new t("media");return t.mediaInstance=n,n},t.resetInstance=function(){t.instance=null},a.setKeepWhileLoop_FOR_TESTING_ONLY=function(t){this.$2=t},t})();y.instance=null,y.mediaInstance=null;function C(){return y.getInstance()}function b(){return y.getMediaInstance()}l.MAWGalleryEventEmitter=u,l.MAWFTSRestoreSync=y,l.getFTSRestoreSync=C,l.getMediaRestoreSync=b}),98);
__d("MWV2MediaViewerDebugMenu.react",["fbt","MWChatMessageBothOrientationFocusGroup.react","MWDebugMessageMenuItem.react","MWXMenu.react","MWXPopover.react","focusScopeQueries","react","react-compiler-runtime"],(function(t,n,r,o,a,i,l,s){"use strict";var e,u=e||(e=o("react")),c=s._(/*BTDS*/"Debug actions");function d(e){var t=o("react-compiler-runtime").c(3),n=e.attachment,a=e.message,i;return t[0]!==n||t[1]!==a?(i=u.jsx(r("MWXPopover.react"),{role:"menu",withArrow:!0,children:u.jsx(o("MWChatMessageBothOrientationFocusGroup.react").keyCommands,{children:u.jsx(o("MWChatMessageBothOrientationFocusGroup.react").FocusGroup,{allowModifiers:!0,orientation:"both",preventScrollOnFocus:!1,tabScopeQuery:o("focusScopeQueries").tabbableScopeQuery,children:u.jsx(r("MWXMenu.react"),{"aria-label":c,size:"full",truncate:!0,children:u.jsx(r("MWDebugMessageMenuItem.react"),{attachment:n,message:a})})})})}),t[0]=n,t[1]=a,t[2]=i):i=t[2],i}l.default=d}),226);