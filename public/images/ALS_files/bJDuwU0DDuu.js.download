;/*FB_PKG_DELIM*/

__d("LSHandleAddDeviceSuccess",["LSLogMebClientEvent.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] Beginning execution."),e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_sproc_start"):t.resolve()},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_load_backup_state_start"):t.resolve()},function(o){return t.filter(t.db.table(168).fetch([[[e[0]]]]),function(n){return t.i64.eq(n.backupId,e[0])&&t.blobs.eq(n.devicePublicKeyBlob,e[2])}).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_error","LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure: backup client state is empty"):t.resolve()},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,4])})},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] backup client state is empty"),r[9]="backup client state is empty",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] ","",r[9]].join("")),r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure",r[9],r[8],t.i64.cast([0,3]))}]):(a=l.item,t.sequence([function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_load_backup_state_end"):t.resolve()},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_mark_backup_state_authoritative_start"):t.resolve()},function(n){return t.forEach(t.db.table(168).fetch([[[e[0]]]]),function(n){var r=n.update,o=n.item;return r({deviceId:e[1],authorityLevel:t.i64.cast([0,80])})})},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,2])})},function(n){return t.forEach(t.db.table(169).fetch([[[e[0]]],"fk_secure_encrypted_backups_client_state"]),function(e){var n=e.update,r=e.item;return n({authorityLevel:t.i64.cast([0,80])})})},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_mark_backup_state_authoritative_end"):t.resolve()},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_invoke_initialize_restore_sproc_start"):t.resolve()},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_invoke_initialize_restore_sproc_end"):t.resolve()}]))})},function(r){return e[3]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[3],"dasm_handle_add_device_success_sproc_end"):t.resolve()},function(e){return r[2]=t.i64.of_float(Date.now()),r[3]=t.i64.random(),r[5]="Finishing execution. Execution time: ",r[6]=t.i64.to_string(t.i64.sub(r[2],r[0])),r[7]=" ms",r[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure] ",r[4],r[5],r[4],r[6],r[4],r[7]].join("")),t.i64.eq(t.i64.mod_(r[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[8]=",",r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure",[r[5],r[8],r[6],r[8],r[7]].join(""),r[9],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsHandleAddDeviceSuccessStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"],a.exports=e}),null);