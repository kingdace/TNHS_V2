;/*FB_PKG_DELIM*/

__d("FtsFetchEbMessagesEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6752"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_end",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6753"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_end",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6754"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_start",e),u=s;l.default=u}),98);
__d("FtsFetchEbMessagesStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6755"),s=o("FalcoLoggerInternal").create("fts_fetch_eb_messages_start",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6776"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_end",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6777"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_end",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6778"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_start",e),u=s;l.default=u}),98);
__d("FtsFetchOccamThreadsStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("6779"),s=o("FalcoLoggerInternal").create("fts_fetch_occam_threads_start",e),u=s;l.default=u}),98);
__d("LSFetchFtsThreads",["LSIssueNewTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return r[0]=new t.Map,r[0].set("timestamp",e[0]),r[0].set("session_id",e[1]),r[1]=t.toJSON(r[0]),t.storedProcedure(n("LSIssueNewTask"),"fts_thread_fetch",t.i64.cast([0,760]),r[1],void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]),void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]))},function(e){return t.resolve(o)}])}e.__sproc_name__="LSFTSThreadsFetchFtsThreadsStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSFetchFtsThreadsStoredProcedure",["LSFetchFtsThreads","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSFetchFtsThreads"),a.timestamp,a.sessionId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWFTSRestoreCap",["WATimeUtils","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("1658"),s=o("WATimeUtils").DAY_MILLISECONDS*e,u=Date.now()-s;function c(e){return e>u}l.RESTORE_CAP_DATE_MS=u,l.isRestoreTimeWithinCap=c}),98);
__d("MAWFTSRestoreSyncLogger",["FtsFetchEbMessagesEndFalcoEvent","FtsFetchEbMessagesPageEndFalcoEvent","FtsFetchEbMessagesPageStartFalcoEvent","FtsFetchEbMessagesStartFalcoEvent","FtsFetchOccamThreadsEndFalcoEvent","FtsFetchOccamThreadsPageEndFalcoEvent","FtsFetchOccamThreadsPageStartFalcoEvent","FtsFetchOccamThreadsStartFalcoEvent","MAWBridgeSendAndReceive"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set,s=new Set,u=null,c=!1,d=0,m=0;async function p(){u!=null&&u!==""||(u=await o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSRestoreSessionId"))}function _(t,n,o){if(!n||s.has(t)){s.add(t);return}e.has(t)||(e.add(t),o&&r("FtsFetchEbMessagesStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})),r("FtsFetchEbMessagesPageStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})}function f(t,n,o){s.has(t)||!e.has(t)||(r("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:n.toString(),session_id:u!=null?u:""}}),o||(s.add(t),r("FtsFetchEbMessagesEndFalcoEvent").log(function(){return{app_name:"",duration:0,session_id:u!=null?u:"",total_messages_count:"0"}})))}function g(t){s.has(t)||!e.has(t)||r("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:"0",session_id:u!=null?u:""}})}function h(){r("FtsFetchOccamThreadsEndFalcoEvent").log(function(){return{app_name:"",duration:0,remaining_threads_count:m.toString(),session_id:u!=null?u:"",total_threads_count:d.toString()}})}function y(){c||(c=!0,r("FtsFetchOccamThreadsStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})),r("FtsFetchOccamThreadsPageStartFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:""}})}function C(e){r("FtsFetchOccamThreadsPageEndFalcoEvent").log(function(){return{app_name:"",session_id:u!=null?u:"",thread_count:e.toString()}})}function b(e){d++,e||m++}l.initLoggingSessionId=p,l.onFetchMessagePageStart=_,l.onFetchMessagePageComplete=f,l.onFetchMessagePageFailed=g,l.onFetchThreadsComplete=h,l.onFetchThreadsPageStart=y,l.onFetchThreadsPageComplete=C,l.incrementTotalResultCount=b}),98);
__d("ThreadsDoublyLinkedList",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){this.value=t},l=(function(){function t(){this.$1=new Map,this.$2=null,this.$3=null}var n=t.prototype;return n.getHead=function(){if(this.$2!=null)return this.$2.value},n.has=function(t){return this.$1.has(t)},n.size=function(){return this.$1.size},n.insertToHead=function(n){this.getHead()!==n&&(this.has(n)&&this.remove(n),this.$2==null?this.add(n):(this.$2.prev=new e(n),this.$2.prev.next=this.$2,this.$2=this.$2.prev,this.$1.set(n,this.$2)))},n.add=function(n){if(!this.has(n)){if(!this.$2){this.$2=new e(n),this.$3=this.$2,this.$1.set(n,this.$2);return}this.$3!=null&&(this.$3.next=new e(n),this.$3.next.prev=this.$3,this.$3=this.$3.next,this.$1.set(n,this.$3))}},n.remove=function(t){var e=this.$1.get(t);e!=null&&(e.prev!=null&&(e.prev.next=e.next),e.next!=null&&(e.next.prev=e.prev),e===this.$2&&(this.$2=e.next),e===this.$3&&(this.$3=e.prev),this.$1.delete(t))},t})();i.default=l}),66);
__d("MAWFTSThreadsRestore",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSFetchFtsThreadsStoredProcedure","LSMessagingThreadTypeUtil","MAWBridgeSendAndReceive","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWJids","ReQL","ThreadsDoublyLinkedList","WAJids","emptyFunction","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(function(){function t(){this.$1=new Map,this.$4=!1,this.$5=(e||(e=o("I64"))).zero,this.$6=!1,this.$7=new Set,r("FBLogger")("messenger_web").info("New MAWFTSThreadsRestore instance"),this.$2=new(r("ThreadsDoublyLinkedList"))}var n=t.prototype;return n.startThreadsRestore=async function(){this.$4||(this.$4=!0,this.$6=!0,await o("MAWFTSRestoreSyncLogger").initLoggingSessionId(),await this.$8(),await this.$9())},n.isThreadQueryInProgress=function(){return this.$6||this.$7.size>0},n.getInitialLastActivityTimeForThreadMs=function(t){return this.$1.get(t)},n.getThreadsHead=function(){return this.$2.getHead()},n.hasThread=function(t){return this.$2.has(t)},n.insertIntoHead=function(t){this.$2.insertToHead(t)},n.removeThread=function(t){this.$2.remove(t)},n.$10=function(t,n){o("MAWFTSRestoreSyncLogger").onFetchThreadsPageStart(),t.runInTransaction(function(e){return r("LSFetchFtsThreadsStoredProcedure")(r("LSFactory")(e),{sessionId:"",timestamp:n})},"readwrite",void 0,void 0,i.id+":123")},n.$11=function(n,a,i){i===void 0&&(i=r("emptyFunction")),this.$6=!0;var t=a.hasNextPage,l=a.nextPageCursor,s=a.resultCount,u=(e||(e=o("I64"))).to_int32(s),c=!e.equal(l,this.$5),d=o("MAWFTSRestoreCap").isRestoreTimeWithinCap(e.to_float(l));c&&o("MAWFTSRestoreSyncLogger").onFetchThreadsPageComplete(u),t&&d?c&&(this.$5=l,this.$10(n,l)):(this.$6=!1,this.$7.size===0&&o("MAWFTSRestoreSyncLogger").onFetchThreadsComplete(),i())},n.$8=async function(){var t=this,n=await this.$12(),r=o("ReQL").fromTableAscending(n.tables.messenger_fts_threads_queries,["hasNextPage","nextPageCursor","resultCount"]),a={contents:function(){}};a.contents=r.subscribe(function(e,r){r.operation!=="delete"&&t.$11(n,r.value,a.contents)});var i=await o("ReQL").firstAsync(r);i?this.$11(n,i):this.$10(n,(e||(e=o("I64"))).max_int)},n.$13=function(n){var t=this,a=n.nextMessageTimestamp,i=n.threadId,l=n.threadType,s=(e||(e=o("I64"))).to_string(i),u=o("LSMessagingThreadTypeUtil").isGroup(l),c=u?o("WAJids").toGroupJid(s):o("MAWJids").toUserJid(s);this.$7.add(c),r("promiseDone")(o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSNextTimestamp",{threadId:c}).then(function(n){var r=(e||(e=o("I64"))).to_float(a);if(o("MAWFTSRestoreCap").isRestoreTimeWithinCap(r)){if(!t.$1.has(c)){t.$1.set(c,r);var i=n!=null&&!o("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(n,10));o("MAWFTSRestoreSyncLogger").incrementTotalResultCount(i)}if(n!=="0")return t.$2.add(o("WAJids").unsafeCoerceToChatJid(c)),o("MAWBridgeSendAndReceive").sendAndReceive("backend","searchSetFTSNextTimestamp",{newSortOrderMs:e.to_string(a),threadId:c})}}).finally(function(){t.$7.delete(c),t.$7.size===0&&!t.$6&&o("MAWFTSRestoreSyncLogger").onFetchThreadsComplete()}))},n.$9=async function(){var e=this,t=await this.$12(),n=o("ReQL").fromTableAscending(t.tables.messenger_fts_threads,["threadId","nextMessageTimestamp","threadType"]);n.subscribe(function(t,n){n.operation==="add"&&e.$13(n.value)});var r=await o("ReQL").toArrayAsync(n);r.forEach(function(t){e.$13(t)})},n.$12=async function(){return this.$3==null&&(this.$3=await(s||(s=o("LSDatabaseSingleton"))).LSDatabaseSingleton),this.$3},t})();function d(){return u==null&&(u=new c),u}l.MAWFTSThreadsRestore=c,l.getInstance=d}),98);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["ExecutionEnvironment","LSDatabaseSingleton","LSVec","WAJobOrchestratorTypes","cr:10036","cr:9465","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=r("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function c(t,a,l,c,d,m,p,_,f,g,h,y){return y===void 0&&(y=o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION),u.load().then(async function(u){var C=g!=null?Number(g):void 0,b=n("cr:9465")!=null?n("cr:9465").getMessageMetadataFromDeanonAPI(a,l.length,C):Promise.resolve(),v,S;return(s||(s=r("ExecutionEnvironment"))).isInWorker&&n("cr:10036")!=null?(await n("cr:10036").init(),v=await n("cr:10036").getLSStorage()):(v=await(e||(e=o("LSDatabaseSingleton"))).LSDatabaseSingleton,S=await b),v.runInTransaction(function(e){return u.call(e,t,a,l,c,d,m,p,_,f,g,h,S,y,void 0)},"readwrite",void 0,void 0,i.id+":71").then(function(){return[r("LSVec").ofArray([]),r("LSVec").ofArray([]),!1]})})}l.call=c}),98);