;/*FB_PKG_DELIM*/

__d("MWEBAutoRestoreNoticeDialog.react",["MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWXMultiStepDialog_DEPRECATED.react","deferredLoadComponent","react","react-compiler-runtime","requireDeferredForDisplay"],(function(t,n,r,o,a,i,l){"use strict";var e,s=e||(e=o("react")),u=r("deferredLoadComponent")(r("requireDeferredForDisplay")("MWEBAutoRestoreNoticeDialogStep.react").__setRef("MWEBAutoRestoreNoticeDialog.react"));function c(e){var t=o("react-compiler-runtime").c(7),n=e.onClose,a;t[0]!==n?(a=function(){o("MWChatEncryptedBackupsLogging").endSuccess({event:o("MWChatEncryptedBackupsQPLEvents").restoreWithAutoRestoreConsentQplEvent}),n()},t[0]=n,t[1]=a):a=t[1];var i=a,l;t[2]!==i?(l=function(t){return s.jsx(u,{onComplete:i,pushPage:t})},t[2]=i,t[3]=l):l=t[3];var c;return t[4]!==i||t[5]!==l?(c=s.jsx(r("MWXMultiStepDialog_DEPRECATED.react"),{disableClosingWithMask:!0,onClose:i,withCloseButton:!0,children:l}),t[4]=i,t[5]=l,t[6]=c):c=t[6],c}l.default=c}),98);
__d("MWEBPinCodeErrorsTypesEnum",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum").Mirrored(["EXTRA_DEVICE_CREATING_FAILED","GENERATE_RECOVERY_CODE_ERROR","REGISTER_VESTA_FAILED"]),l=e;i.default=l}),66);
__d("MWEBPinCodeChange",["FBLogger","LSEncryptedBackupsCreateVirtualDeviceActionType","MWEBPinCodeErrorsTypesEnum","MWEncryptedBackupsCreateExtraVirtualDeviceDeferred","MWEncryptedBackupsGenerateRecoveryCode","VestaBackupSecretRegister","gkx","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("VestaDeleteAccount").__setRef("MWEBPinCodeChange");function s(t){var n=t.db,a=t.environment,i=t.onFailedExtraDevice,l=t.onPinCodeError,s=t.onStart,u=t.onSuccess,c=t.pinCode,d=function(t){l==null||l(t)},m=async function(t,n){var e=new TextEncoder;await o("VestaBackupSecretRegister").vestaBackupSecretRegister({environment:a,input:{clientId:t,productUseCase:r("gkx")("24066")?"IGD_ENC_BACKUP":"MSGR_ENC_BACKUP",secret:e.encode(n),vestaAccountPin:c}})},p=async function(){await new Promise(function(e,t){return o("MWEncryptedBackupsCreateExtraVirtualDeviceDeferred").encryptedBackupsCreateExtraVirtualDeviceDeferred({actionType:r("LSEncryptedBackupsCreateVirtualDeviceActionType").UNIQUE_VD_TYPE_INSERT,db:n,onFailure:t,onSuccess:e})}),u()},_=async function(n,o){i==null||i(),r("FBLogger")("wmi_eb").catching(n).mustfix("[reset-pin] Error when creating extra virtual device with PIN"),d(r("MWEBPinCodeErrorsTypesEnum").EXTRA_DEVICE_CREATING_FAILED);var t=await e.load(),l=t.vestaDeleteAccount;l({clientId:o,environment:a,productUseCase:"MSGR_ENC_BACKUP",updater:function(t){var e,n=(e=t.getRootField("fbid_based_auth_layer_vesta_delete_account"))==null?void 0:e.getLinkedRecord("vesta_user_info");if(n!=null){var r;(r=t.getRoot())==null||(r=r.getLinkedRecord("viewer"))==null||(r=r.getLinkedRecord("messenger_default_encrypted_backup"))==null||(r=r.getLinkedRecord("vesta_user_info"))==null||r.copyFieldsFrom(n)}}})};s(),o("MWEncryptedBackupsGenerateRecoveryCode").encryptedBackupsGenerateRecoveryCode({db:n,virtualDeviceType:2}).then(function(e){var t=e.recoveryCode,n=e.virtualDeviceId;if(t==null||n==null)throw r("FBLogger")("wmi_eb").mustfixThrow("Cannot change a PIN Code without a recovery code");m(n,t).catch(function(e){r("FBLogger")("wmi_eb").mustfix("[reset-pin] Error when registering secret to backup",e.message),d(r("MWEBPinCodeErrorsTypesEnum").REGISTER_VESTA_FAILED)}).then(function(){return p()}).catch(function(e){r("promiseDone")(_(e,n))})}).catch(function(e){r("FBLogger")("wmi_eb").mustfix("[reset-pin] Error when generating recovery code",e.message),d(r("MWEBPinCodeErrorsTypesEnum").GENERATE_RECOVERY_CODE_ERROR)})}l.mwEBPinCodeChange=s}),98);
__d("MWEncryptedBackupsHsmFleetMigration",["FBLogger","I64","LSIntEnum","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEBPinCodeChange","MWEBPinCodeErrorsTypesEnum","QPLUserFlow","ReQL","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return r("gkx")("24065")?!0:(e==null?void 0:e.requiresHsmMigration)===!0}function c(t){var n=t.db,a=t.environment,i=t.pinCode,l=t.startFlow;r("promiseDone")(o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.tables.encrypted_backups_virtual_devices).filter(function(t){return(e||(e=o("I64"))).equal(t.virtualDeviceType,(s||(s=o("LSIntEnum"))).ofNumber(2))})).then(function(e){e&&u(e)&&o("MWEBPinCodeChange").mwEBPinCodeChange({db:n,environment:a,onFailedExtraDevice:function(){r("QPLUserFlow").markError(o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent,"failed_extra_device_created")},onPinCodeError:function(t){switch(t){case r("MWEBPinCodeErrorsTypesEnum").EXTRA_DEVICE_CREATING_FAILED:o("MWChatEncryptedBackupsLogging").endFailure({errorName:"failed_create_extra_device",event:o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break;case r("MWEBPinCodeErrorsTypesEnum").GENERATE_RECOVERY_CODE_ERROR:o("MWChatEncryptedBackupsLogging").endFailure({errorName:"generate_rc_error",event:o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break;case r("MWEBPinCodeErrorsTypesEnum").REGISTER_VESTA_FAILED:o("MWChatEncryptedBackupsLogging").endFailure({errorName:"failed_register_vesta",event:o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent});break}},onStart:function(){l({event:o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent}),r("QPLUserFlow").addPoint(o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent,"hsm_migration_started")},onSuccess:function(){o("MWChatEncryptedBackupsLogging").endSuccess({event:o("MWChatEncryptedBackupsQPLEvents").hsmFleetMigrationQplEvent})},pinCode:i})}),function(){},function(){r("FBLogger")("wmi_eb").mustfix("[Encrypted Backups] HSM fleet migration - Failed to fetch virtual devices")})}l.default=c}),98);
__d("MWEncryptedBackupsHsmFleetMigrationGated",["cr:3373"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return n("cr:3373")==null?void 0:n("cr:3373")(e)}l.default=e}),98);